name: Daily Android Build for Firebase

on:
  schedule:
    - cron: '0 9 * * *'   # 09:00 UTC
  workflow_dispatch:
  push:
    branches: [feature/setup-firebase-distribution-action]

jobs:
  android-build:
    runs-on: ubuntu-latest

    steps:
      # ----------------- CHECKOUT -----------------
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------- JAVA -----------------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # ----------------- VERSIONING -----------------
      - name: Bump versionCode
        run: |
          FILE=composeApp/build.gradle.kts
          CODE=$(grep "versionCode" $FILE | sed 's/[^0-9]*//g')
          NEW=$((CODE+1))
          sed -i "s/versionCode = $CODE/versionCode = $NEW/" $FILE
          echo "New versionCode: $NEW"

      - name: Set versionName with date and time
        run: |
          FILE=composeApp/build.gradle.kts
          DATETIME=$(date +%Y%m%d-%H%M)
          sed -i "s/versionName = \".*\"/versionName = \"0.1.0-$DATETIME\"/" $FILE
          echo "versionName set to 0.1.0-$DATETIME"

      # ----------------- KEYSTORE -----------------
      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks

      - name: Check Keystore exists
        run: |
          if [ ! -f keystore.jks ]; then
            echo "Keystore not found!"
            exit 1
          fi
          ls -lh keystore.jks

      # ----------------- BUILD -----------------
      - name: Build AAB
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: ./gradlew :androidApp:bundleRelease

      - name: Check AAB exists
        run: |
          AAB_PATH=$(find composeApp/build/outputs -name "*.aab")
          echo "Found AAB at $AAB_PATH"
          if [ ! -f "$AAB_PATH" ]; then
            echo "ERROR: AAB not found!"
            exit 1
          fi

      # ----------------- FIREBASE -----------------
      - name: Upload to Firebase
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          token: ${{ secrets.FIREBASE_TOKEN }}
          groups: beta-testers
          file: ${{ steps.check-aab.outputs.AAB_PATH || 'composeApp/build/outputs/bundle/release/composeApp-release.aab' }}
